<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор материалов</title>
  <style>
    body {
      background-color: #0b1d2a;
      color: #93a7a2;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1 {
      color: #daa548;
      text-align: center;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #102633;
      color: #93a7a2;
      box-shadow: 0 0 10px #000;
    }
    th, td {
      border: 1px solid #1f3c4d;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #123b50;
      color: #daa548;
    }
    input[type="text"], select {
      background-color: #081c27;
      color: #00f7ff;
      border: 1px solid #1f3c4d;
      width: 140px;
      text-align: center;
    }
    .material-output {
      color: #00f7ff;
      display: inline-block;
      width: 100px;
      text-align: center;
    }
    .icon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-right: 6px;
    }
    .copy-icon {
      cursor: pointer;
      margin-left: 6px;
    }
    .block {
      flex: 1;
    }
    .toggle-row {
      background-color: #081c27;
      border: 1px solid #1f3c4d;
      padding: 8px;
      text-align: center;
      margin-bottom: 10px;
      color: #daa548;
    }
  </style>
  <script>
    function formatNumberWithSpaces(value) {
      const str = value.toString().replace(/\D/g, '');
      return str.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    function parseInputToNumber(value) {
      const cleaned = value.replace(/\s+/g, '').replace(/,/g, '.');
      if (cleaned.toLowerCase().includes('трлн')) {
        const num = parseFloat(cleaned.replace(/[^\d\.]/g, ''));
        return Math.round(num * 1_000_000_000_000);
      }
      return parseInt(cleaned) || 0;
    }

    function formatTrillions(value) {
      const num = typeof value === 'number' ? value : parseInputToNumber(value);
      if (num >= 1_000_000_000_000) {
        const trillions = num / 1_000_000_000_000;
        let result = trillions.toFixed(3).replace(/\.0+$/, '').replace(/(\.\d*?)0+$/, '$1');
        return result + ' трлн';
      }
      return formatNumberWithSpaces(num);
    }

    function copyRowValue(name, input) {
      const value = input.value;
      const parsed = parseInputToNumber(value);
      const text = `${name}: ${formatNumberWithSpaces(parsed)} шт.`;
      navigator.clipboard.writeText(text);
    }

    const recipes = {
      "Электронные компоненты": { "Железная руда": 1, "Полиэлементная руда": 1, "Крокит": 1 },
      "Алюминий": { "Железная руда": 1, "Полиэлементная руда": 2, "Иридиум": 1 },
      "Сталь": { "Железная руда": 2, "Полиэлементная руда": 1, "Митрацит": 1 },
      "Титановый сплав": { "Железная руда": 1, "Полиэлементная руда": 1, "Титанит": 1 },
      "Нановолокно": { "Железная руда": 1, "Полиэлементная руда": 1, "Брадий": 1 },
      "Полимеры": { "Полиорганическая руда": 2, "Полиэлементная руда": 1 },
      "Композиты": { "Полиорганическая руда": 2, "Полиэлементная руда": 1, "Железная руда": 1, "Иридиум": 1, "Митрацит": 1 }
    };

    function getOreValues() {
      const inputs = document.querySelectorAll(".ore-input");
      const oreValues = {};
      inputs.forEach(input => {
        const row = input.closest("tr");
        const oreName = row.querySelector("td:nth-child(2)").textContent.trim();
        oreValues[oreName] = parseInputToNumber(input.value);
      });
      return oreValues;
    }

    function getEfficiency(select) {
      const value = select.value.replace('%', '');
      return parseInt(value, 10) / 100;
    }

function calculateMaterials() {
  const convertEnabled = document.getElementById("convertToggle").checked;
  const ores = getOreValues();

  const baseOresList = ["Железная руда", "Полиэлементная руда", "Полиорганическая руда"];
  const conversionRules = {
    "Уран": { base: 4, bonus: 0.1 },
    "Митрацит": { base: 4, bonus: 0.1 },
    "Иридиум": { base: 4, bonus: 0.1 },
    "Крокит": { base: 6, bonus: 0.1 },
    "Брадий": { base: 20, bonus: 0.1 },
    "Титанит": { base: 40, bonus: 0.1 },
  };

  const materialRows = Array.from(document.querySelectorAll("table tbody tr"))
    .map(row => {
      const nameCell = row.querySelector("td:nth-child(2)");
      const output = row.querySelector(".material-output");
      const select = row.querySelector("select");
      if (!nameCell || !output || !select) return null;

      return {
        row,
        name: nameCell.textContent.trim(),
        output,
        select,
        percent: parseInt(select.value.replace('%', '')) || 0,
        recipe: recipes[nameCell.textContent.trim()]
      };
    })
    .filter(Boolean)
    .filter(m => m.recipe);

  if (!convertEnabled) {
    // Классическая логика: расчёт по доступным ресурсам
    materialRows.forEach(({ recipe, select, output }) => {
      let maxOutput = Infinity;
      for (const [oreName, required] of Object.entries(recipe)) {
        const available = ores[oreName] || 0;
        maxOutput = Math.min(maxOutput, Math.floor(available / required));
      }
      const efficiency = getEfficiency(select);
      const result = Math.floor(maxOutput * efficiency);
      output.dataset.raw = result;
      output.textContent = formatTrillions(result);
    });
    return;
  }

  // Распределение базовой руды
  const active = materialRows.filter(m => m.percent > 0);
  const totalPercent = active.reduce((sum, m) => sum + m.percent, 0);

  const baseOrePool = baseOresList.reduce((sum, ore) => sum + (ores[ore] || 0), 0);
  if (totalPercent === 0 || baseOrePool === 0) {
    materialRows.forEach(({ output }) => {
      output.dataset.raw = 0;
      output.textContent = "0";
    });
    return;
  }

  active.forEach(({ recipe, name, percent, output }) => {
    const oreCopy = JSON.parse(JSON.stringify(ores));
    let allocatedOre = (percent / totalPercent) * baseOrePool;

    // Попробуем синтезировать недостающие минералы, если нужно
    for (const [oreName, required] of Object.entries(recipe)) {
      const available = oreCopy[oreName] || 0;

      if (required > 0 && available < 999999999) { // немного фейлсейф, чтобы не падало
        const conversion = conversionRules[oreName];
        if (conversion && available < required * 10000) {
          // сколько нужно
          const shortage = Math.max(0, required * 10000 - available); // запас с запасом
          const unitsToCreate = shortage;
          const costPerUnit = conversion.base * (1 + conversion.bonus);
          const totalCost = unitsToCreate * costPerUnit;

          if (allocatedOre >= totalCost) {
            oreCopy[oreName] = (oreCopy[oreName] || 0) + unitsToCreate;
            allocatedOre -= totalCost;
          }
        }
      }
    }

    // Теперь считаем, сколько можно произвести
    let maxOutput = Infinity;
    for (const [oreName, required] of Object.entries(recipe)) {
      const available = oreCopy[oreName] || 0;
      maxOutput = Math.min(maxOutput, Math.floor(available / required));
    }

    output.dataset.raw = maxOutput;
    output.textContent = formatTrillions(maxOutput);
  });
}

    let maxOutput = Infinity;
    for (const [oreName, required] of Object.entries(recipe)) {
      const available = availableOres[oreName] || 0;
      maxOutput = Math.min(maxOutput, Math.floor(available / required));
    }

    const efficiency = getEfficiency(select);
    const result = Math.floor(maxOutput * efficiency);
    outputCell.dataset.raw = result;
    outputCell.textContent = formatTrillions(result);
  });
}

    function copyMaterialValue(name, outputSpan) {
      const raw = outputSpan.dataset.raw || "0";
      const text = `${name}: ${formatNumberWithSpaces(raw)} шт.`;
      navigator.clipboard.writeText(text);
    }

    function attachCalcListeners() {
      document.querySelectorAll(".ore-input").forEach(input => {
        input.addEventListener("input", calculateMaterials);
        input.addEventListener("blur", calculateMaterials);
      });

      document.querySelectorAll("select").forEach(select => {
        select.addEventListener("change", calculateMaterials);
      });

      document.getElementById("convertToggle").addEventListener("change", calculateMaterials);
    }

    document.addEventListener("DOMContentLoaded", function () {
      const toggle = document.getElementById("convertToggle");
      const selects = document.querySelectorAll("table select");
      const oreInputs = document.querySelectorAll(".ore-input");

      function updateSelectsState() {
        selects.forEach(select => {
          select.disabled = !toggle.checked;
          if (toggle.checked) {
            select.value = "0%";
          } else {
            select.value = "100%";
          }
        });
      }


      toggle.addEventListener("change", updateSelectsState);
      updateSelectsState();

      oreInputs.forEach(input => {
        let lastRawValue = input.value;

        input.addEventListener("focus", () => {
          input.value = lastRawValue;
        });

        input.addEventListener("input", () => {
          lastRawValue = input.value;
        });

        input.addEventListener("blur", () => {
          const parsed = parseInputToNumber(input.value);
          lastRawValue = formatTrillions(parsed);
          input.value = lastRawValue;
        });
      });

      attachCalcListeners();
      calculateMaterials();
    });
  </script>
</head>
<body>
  <h1>Калькулятор материалов</h1>
  <div class="container">
    <!-- Левая колонка: Руда / Минералы -->
    <div class="block">
      <table>
        <thead>
          <tr>
            <th colspan="2">Руда / Минералы</th>
            <th>Количество</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><img class="icon" src="images/productions/1-16.png"></td><td>Железная руда</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Железная руда', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/2-16.png"></td><td>Полиэлементная руда</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Полиэлементная руда', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/3-16.png"></td><td>Полиорганическая руда</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Полиорганическая руда', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/4-16.png"></td><td>Уран</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Уран', this.previousElementSibling)"></td></tr>
          <tr><td colspan="3"><div style="height: 12px; width: 50%; margin: auto;"></div></td></tr>
          <tr><td><img class="icon" src="images/productions/5-16.png"></td><td>Митрацит</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Митрацит', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/6-16.png"></td><td>Иридиум</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Иридиум', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/7-16.png"></td><td>Крокит</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Крокит', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/8-16.png"></td><td>Брадий</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Брадий', this.previousElementSibling)"></td></tr>
          <tr><td><img class="icon" src="images/productions/9-16.png"></td><td>Титанит</td><td><input class="ore-input" type="text" value="0"><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyRowValue('Титанит', this.previousElementSibling)"></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Правая колонка: Материалы -->
    <div class="block">
      <div class="toggle-row">
        <label><input type="checkbox" id="convertToggle"> Преобразовывать руду / минералы</label>
      </div>
      <table>
        <thead>
          <tr>
            <th colspan="2">Материалы</th>
            <th>Объём</th>
            <th>Количество</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><img class="icon" src="images/productions/32-16.png"></td><td>Электронные компоненты</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Электронные компоненты', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/46-16.png"></td><td>Алюминий</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Алюминий', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/47-16.png"></td><td>Сталь</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Сталь', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/48-16.png"></td><td>Титановый сплав</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Титановый сплав', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/49-16.png"></td><td>Нановолокно</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Нановолокно', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/50-16.png"></td><td>Полимеры</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Полимеры', this.previousElementSibling)"></td>
          </tr>
          <tr>
            <td><img class="icon" src="images/productions/51-16.png"></td><td>Композиты</td>
            <td><select>
              <option>100%</option><option>95%</option><option>90%</option><option>85%</option><option>80%</option>
              <option>75%</option><option>70%</option><option>65%</option><option>60%</option><option>55%</option>
              <option>50%</option><option>45%</option><option>40%</option><option>35%</option><option>30%</option>
              <option>25%</option><option>20%</option><option>15%</option><option>10%</option><option>5%</option>
            </select></td>
            <td><span class="material-output" data-raw="0">0</span><img class="copy-icon" src="images/productions/i-copy-16.png" onclick="copyMaterialValue('Композиты', this.previousElementSibling)"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
